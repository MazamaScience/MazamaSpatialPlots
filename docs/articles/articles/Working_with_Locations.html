<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Working with Air Quality Data • MazamaSpatialPlots</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../../bootstrap-toc.css">
<script src="../../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><meta property="og:title" content="Working with Air Quality Data">
<meta property="og:description" content="MazamaSpatialPlots">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">MazamaSpatialPlots</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../../articles/MazamaSpatialPlots.html">Get started</a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/articles/Creating_County_Maps.html">Creating County Maps</a>
    </li>
    <li>
      <a href="../../articles/articles/Creating_State_Maps.html">Creating State Maps</a>
    </li>
    <li>
      <a href="../../articles/articles/Customizing_State_Maps.html">Customizing State Maps</a>
    </li>
    <li>
      <a href="../../articles/articles/Opportunity_Insights.html">Opportunity Insights</a>
    </li>
    <li>
      <a href="../../articles/articles/Working_with_Locations.html">Working with Air Quality Data</a>
    </li>
  </ul>
</li>
<li>
  <a href="../../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/MazamaScience/MazamaSpatialPlots/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="Working_with_Locations_files/header-attrs-2.6/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Working with Air Quality Data</h1>
                        <h4 class="author">Rachel Carroll, Mazama Science</h4>
            
            <h4 class="date">August 7, 2020</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/MazamaScience/MazamaSpatialPlots/blob/master/vignettes/articles/Working_with_Locations.Rmd"><code>vignettes/articles/Working_with_Locations.Rmd</code></a></small>
      <div class="hidden name"><code>Working_with_Locations.Rmd</code></div>

    </div>

    
    
<div id="objective" class="section level2">
<h2 class="hasAnchor">
<a href="#objective" class="anchor"></a>Objective</h2>
<p>The objective of this article is to demonstrate how to make detailed maps from air quality monitoring data. The <strong>PWFSLSmoke</strong> package is used to extract and manipulate the air quality monitoring data from AIRNOW, AIRSIS and WRCC. This data contains particulate matter 2.5 (PM2.5) concentrations at the monitor locations over time. In this demonstration, we create maps that display monitor locations, air quality statistics at monitor locations, and average air quality in a given region.</p>
</div>
<div id="prepare-monitor-data" class="section level2">
<h2 class="hasAnchor">
<a href="#prepare-monitor-data" class="anchor"></a>Prepare Monitor Data</h2>
<p>There are several functions in the <strong>PWFSLSmoke</strong> package that can be used to load air quality monitoring data:</p>
<ul>
<li>
<code><a href="https://rdrr.io/pkg/PWFSLSmoke/man/monitor_load.html">monitor_load()</a></code> - Loads data from a given time range. For example, <code><a href="https://rdrr.io/pkg/PWFSLSmoke/man/monitor_load.html">monitor_load(20170601, 20171001)</a></code> brings in all readings between 06/01/17 and 10/01/17.</li>
<li>
<code><a href="https://rdrr.io/pkg/PWFSLSmoke/man/monitor_loadAnnual.html">monitor_loadAnnual()</a></code> - Loads all data from a given year. For example <code><a href="https://rdrr.io/pkg/PWFSLSmoke/man/monitor_loadAnnual.html">monitor_loadAnnual(2018)</a></code> pulls in all 2018 data.</li>
<li>
<code><a href="https://rdrr.io/pkg/PWFSLSmoke/man/monitor_loadDaily.html">monitor_loadDaily()</a></code> - Loads the past 45 days of data, up to midnight of the most recent full day.</li>
<li>
<code><a href="https://rdrr.io/pkg/PWFSLSmoke/man/monitor_loadDaily.html">monitor_loadDaily()</a></code> - Loads the past 10 days of data, up the current hour.</li>
</ul>
<p>These functions load in the data as a <em>ws_monitor</em> object, which contains 1) a dataframe with air quality monitor readings over time and 2) the monitor-level metadata with characteristics such as monitor locations.</p>
<p>In the example below, data from the past 10 days is loaded and monitor-level calculations are performed. The data can be summarized in any way deemed relevant so long as we end up with one measurement per monitor. This allows us to color monitor location points based on the monitor’s PM2.5 value reading. To accomplish this, the data can be summarized over time or data can be extracted at a specific point in time. In this case, the former method is used to calculate the maximum daily average for each monitor.</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://github.com/MazamaScience/MazamaSpatialPlots">MazamaSpatialPlots</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://github.com/MazamaScience/PWFSLSmoke">PWFSLSmoke</a></span>)

<span class="co"># Load data</span>
<span class="kw">monitorLatestData</span> <span class="op">&lt;-</span> <span class="kw">PWFSLSmoke</span>::<span class="fu"><a href="https://rdrr.io/pkg/PWFSLSmoke/man/monitor_loadLatest.html">monitor_loadLatest</a></span>() <span class="co"># past 10 days of data, up to the current hour</span>

<span class="co"># Prepare Data: Subset and summarize based on desired information</span>
<span class="co"># calculating maximum daily average (one record per monitor)</span>
<span class="kw">dailyMax</span> <span class="op">&lt;-</span>
  <span class="kw">monitorLatestData</span> <span class="op">%&gt;%</span>
  <span class="kw">PWFSLSmoke</span>::<span class="fu"><a href="https://rdrr.io/pkg/PWFSLSmoke/man/monitor_dailyStatistic.html">monitor_dailyStatistic</a></span>(minHours = <span class="fl">2</span>) <span class="op">%&gt;%</span> <span class="co"># daily average</span>
  <span class="kw">PWFSLSmoke</span>::<span class="fu"><a href="https://rdrr.io/pkg/PWFSLSmoke/man/monitor_extractDataFrame.html">monitor_extractData</a></span>() <span class="op">%&gt;%</span> 
  <span class="kw">tidyr</span>::<span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span>(<span class="op">-</span><span class="kw">datetime</span>, names_to = <span class="st">"monitorID"</span>, values_to = <span class="st">"value"</span>) <span class="op">%&gt;%</span>
  <span class="kw">dplyr</span>::<span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="kw">monitorID</span>) <span class="op">%&gt;%</span> 
  <span class="kw">dplyr</span>::<span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(pm25 = <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">value</span>, na.rm = <span class="fl">TRUE</span>)) <span class="op">%&gt;%</span> <span class="co"># taking maximum daily average</span>
  <span class="kw">dplyr</span>::<span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span>(<span class="kw">monitorLatestData</span><span class="op">$</span><span class="kw">meta</span>, by = <span class="st">'monitorID'</span>) <span class="op">%&gt;%</span>
  <span class="kw">dplyr</span>::<span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(
    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'monitorID'</span>, <span class="st">'stateCode'</span>, <span class="st">'latitude'</span>, <span class="st">'longitude'</span>, <span class="st">'pwfslDataIngestSource'</span>, <span class="st">'pm25'</span>))

<span class="co"># Clean pm25 column by setting -Inf values to NA</span>
<span class="kw">dailyMax</span><span class="op">$</span><span class="kw">pm25</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/replace.html">replace</a></span>(<span class="kw">dailyMax</span><span class="op">$</span><span class="kw">pm25</span>, <span class="kw">dailyMax</span><span class="op">$</span><span class="kw">pm25</span> <span class="op">==</span> <span class="op">-</span><span class="fl">Inf</span>, <span class="fl">NA</span>)
</pre></div>
<p>Now the <em>ws_monitor</em> object, <code>monitorLatestData</code> and the monitor-level dataframe, <code>dailyMax</code>, can be used to create air quality maps as demonstrated in the following sections.</p>
</div>
<div id="plot-monitor-locations" class="section level2">
<h2 class="hasAnchor">
<a href="#plot-monitor-locations" class="anchor"></a>Plot Monitor Locations</h2>
<p>To simply plot monitor locations without colors, monitor-level calculations are not yet needed. Instead, the metadata of <code>monitorLatestData</code> can be used directly. We also introduce a U.S. state Spatial Polygons Data Frame (SPDF) so the monitor locations will appear on a map of U.S. states.</p>
<p>For simplicity, we won’t project the data at all.</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="co"># Get state codes and only include continental US states</span>
<span class="kw">stateCodeList</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="kw">monitorLatestData</span><span class="op">$</span><span class="kw">meta</span><span class="op">$</span><span class="kw">stateCode</span>) 
<span class="kw">stateCodeList</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(
  <span class="kw">stateCodeList</span>, <span class="kw">stateCodeList</span> <span class="op">%in%</span> <span class="kw">MazamaSpatialUtils</span>::<span class="kw"><a href="https://rdrr.io/pkg/MazamaSpatialUtils/man/CONUS.html">CONUS</a></span>
  )
<span class="co"># Create subsetted U.S. state SPDF</span>
<span class="kw">stateSPDF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(<span class="kw">USCensusStates_02</span>, <span class="kw">stateCode</span> <span class="op">%in%</span> <span class="kw">stateCodeList</span>)

<span class="co"># Plot U.S. state SPDF</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw">stateSPDF</span>)  

<span class="co"># Overlay monitor location points</span>
<span class="co"># NOTE: can use either dailyMax or monitorLatestData$meta since both have metadata </span>
<span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span>(<span class="kw">monitorLatestData</span><span class="op">$</span><span class="kw">meta</span><span class="op">$</span><span class="kw">longitude</span>, <span class="kw">monitorLatestData</span><span class="op">$</span><span class="kw">meta</span><span class="op">$</span><span class="kw">latitude</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span>(<span class="kw">monitorLatestData</span><span class="op">$</span><span class="kw">meta</span><span class="op">$</span><span class="kw">longitude</span>, <span class="kw">monitorLatestData</span><span class="op">$</span><span class="kw">meta</span><span class="op">$</span><span class="kw">latitude</span>)
</pre></div>
<p><img src="Working_with_Locations_files/figure-html/monitor_locs-1.png" width="700"></p>
<p>Another method to map monitor loactions is to use the <code><a href="https://rdrr.io/pkg/PWFSLSmoke/man/monitor_map.html">monitor_map()</a></code> function from <strong>PWFSLSmoke</strong>. In fact, this function can also color the monitor location points (by default, the maximum measurement per monitor is used to color the points). This function is very useful when taking a quick look across the continental U.S. However, the method above allows for some more flexibility in subsetting states and calculating desired monitor-level statistics.</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="co"># method 2 using monitor_map() from PWFSLSmoke</span>
<span class="kw">PWFSLSmoke</span>::<span class="fu"><a href="https://rdrr.io/pkg/PWFSLSmoke/man/monitor_map.html">monitor_map</a></span>(
  <span class="kw">monitorLatestData</span>, 
  countyCol = <span class="fl">NA</span>,
  colors = <span class="st">'grey50'</span>,
  stateCol = <span class="st">"black"</span>,
  pch = <span class="fl">3</span>,
  stateLwd = <span class="fl">3</span>
)
</pre></div>
<p><img src="Working_with_Locations_files/figure-html/monitor_locs2-1.png" width="700"></p>
</div>
<div id="plot-monitor-values" class="section level2">
<h2 class="hasAnchor">
<a href="#plot-monitor-values" class="anchor"></a>Plot Monitor Values</h2>
<p>To build upon the examples above, this section shows how to plot points on a map with added visual customizations. To create descriptive visualizations of this nature, it is a good idea to transform the locations data into a <em>SpatialPointsDataFrame</em>. This is because SPDFs are compatible with the <strong>tmap</strong> package, which allows us to create attractive maps with high flexibility.</p>
<p>Below, monitor locations are again plotted on a plain continental U.S. map. In this example, however, <strong>tmap</strong> is used so the overall layout, color schemes, legend break points, and point shapes are easily specified. Notice that AIRNOW monitors are displayed as circles and AIRSIS and WRCC monitors are triangles. This is done by simply defining the shape parameter in <code>tm_symbols()</code> with the data source column. This cannot be done using <code><a href="https://rdrr.io/pkg/PWFSLSmoke/man/monitor_map.html">PWFSLSmoke::monitor_map()</a></code> and would require longer messier code to create directly using <code><a href="https://rdrr.io/r/graphics/plot.html">plot()</a></code> and <code><a href="https://rdrr.io/r/graphics/points.html">points()</a></code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="co"># transform monitorLatestData into a SpatialPointsDataFrame </span>
<span class="co"># TODO: make this a function called monitor_toSPDF ?????</span>
<span class="kw">geojson_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span>(fileext = <span class="st">".geojson"</span>)
<span class="kw">current_geojson</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/PWFSLSmoke/man/monitor_writeCurrentStatusGeoJSON.html">monitor_writeCurrentStatusGeoJSON</a></span>(<span class="kw">monitorLatestData</span>, <span class="kw">geojson_file</span>)
<span class="kw">current_list</span> <span class="op">&lt;-</span> <span class="kw">jsonlite</span>::<span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html">fromJSON</a></span>(<span class="kw">current_geojson</span>)
<span class="kw">monitorSPDF</span> <span class="op">&lt;-</span> <span class="kw">rgdal</span>::<span class="fu"><a href="https://rdrr.io/pkg/rgdal/man/readOGR.html">readOGR</a></span>(dsn = <span class="kw">geojson_file</span>, verbose = <span class="fl">FALSE</span>)

<span class="co"># bring in pm25 field from dailyMax </span>
<span class="kw">monitorSPDF</span><span class="op">@</span>data <span class="op">&lt;-</span> <span class="kw">monitorSPDF</span><span class="op">@</span>data <span class="op">%&gt;%</span>
  <span class="kw">dplyr</span>::<span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span>(<span class="kw">dailyMax</span>[, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"monitorID"</span>, <span class="st">"pm25"</span>)], by = <span class="st">"monitorID"</span>) <span class="op">%&gt;%</span>
  <span class="kw">dplyr</span>::<span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(  
    plotDataSource = <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(
      <span class="kw">pwfslDataIngestSource</span> <span class="op">==</span> <span class="st">"AIRNOW"</span>, 
      <span class="st">"AIRNOW"</span>, 
      <span class="st">"AIRSIS or WRCC"</span>)
    ) <span class="op">%&gt;%</span>
  <span class="kw">dplyr</span>::<span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(
    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"monitorID"</span>, <span class="st">"stateCode"</span>, <span class="st">"longitude"</span>, <span class="st">"latitude"</span>, <span class="st">"plotDataSource"</span>, <span class="st">"pm25"</span>)
    )

<span class="co">#createMap</span>
<span class="kw">tmap</span>::<span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape</a></span>(<span class="kw">stateSPDF</span>, 
               bbox = <span class="fu">bbox</span>(<span class="kw">monitorSPDF</span>) <span class="co">#use monitor bbox </span>
               ) <span class="op">+</span>
  <span class="kw">tmap</span>::<span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html">tm_polygons</a></span>(
    col = <span class="st">"grey85"</span>,
    border.col = <span class="st">"black"</span>) <span class="op">+</span>
  <span class="kw">tmap</span>::<span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape</a></span>(<span class="kw">monitorSPDF</span>) <span class="op">+</span>  <span class="co"># plot colored monitor location points </span>
  <span class="kw">tmap</span>::<span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_symbols.html">tm_symbols</a></span>(              
    col = <span class="st">"pm25"</span>,
    palette = <span class="st">"Reds"</span>,
    breaks = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">0</span>, <span class="fl">50</span>, <span class="fl">5</span>), <span class="fl">1000</span>), <span class="co"># NOTE: all values are between 0 and 50 except 2 (outliers?)</span>
    shape = <span class="st">"plotDataSource"</span>,        <span class="co"># shape of points will depend on the monitor source</span>
    shapes = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">16</span>, <span class="fl">17</span>),              <span class="co"># specify circles and triangle shapes</span>
    scale = <span class="fl">.4</span>) <span class="op">+</span>
  <span class="kw">tmap</span>::<span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_layout.html">tm_layout</a></span>(
    main.title = <span class="st">"Latest Average Daily Max Monitor Reading"</span>,
    main.title.position = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"center"</span>, <span class="st">"top"</span>),
    bg.color = <span class="st">"deepskyblue4"</span>,
    attr.color = <span class="st">"white"</span>,
    legend.position = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"left"</span>, <span class="st">"center"</span>)
  )
</pre></div>
<p><img src="Working_with_Locations_files/figure-html/monitor_vals-1.png" width="700"></p>
</div>
<div id="plot-polygon-summarized-values" class="section level2">
<h2 class="hasAnchor">
<a href="#plot-polygon-summarized-values" class="anchor"></a>Plot Polygon Summarized Values</h2>
<p>In this section <code><a href="https://rdrr.io/pkg/MazamaSpatialUtils/man/summarizeByPolygon.html">MazamaSpatialUtils::summarizeByPolygon()</a></code> is introduced. The purpose of this function is to summarize spatial data by regions defined by the polygons in a given SPDF. For example, using a U.S. state level SPDF would summarize the data by state while a U.S. county SPDF would summarize by county. The input spatial data must contain latitude, longitude, and a value to be summarized.</p>
<p>Below, <code><a href="https://rdrr.io/pkg/MazamaSpatialUtils/man/summarizeByPolygon.html">MazamaSpatialUtils::summarizeByPolygon()</a></code> is used with a U.S. state SPDF and the dataframe <code>dailyMax</code> (created in the “Prepare Monitor Data” section above) to find average PM2.5 readings by state. These state-level values are incorporated into the state SPDF’s data <code>@slot</code> so the map can be colored by the summarized values.</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="co"># replacing NA with 0. </span>
<span class="co"># NOTE: should add na.rm argument to summarizeByPolygon() so we can </span>
<span class="co"># NOTE: use dailyMax$pm25 directly in the function. This step will bring down </span>
<span class="co"># NOTE: the average value which is NOT GOOD </span>
<span class="kw">stateSPDF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(<span class="kw">USCensusStates_02</span>, <span class="kw">stateCode</span> <span class="op">%in%</span> <span class="kw">stateCodeList</span>)

<span class="kw">newValueVector</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/replace.html">replace</a></span>(<span class="kw">dailyMax</span><span class="op">$</span><span class="kw">pm25</span>, <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="kw">dailyMax</span><span class="op">$</span><span class="kw">pm25</span>), <span class="fl">0</span>)

<span class="co"># Summarize by State</span>
<span class="kw">stateSummarizedDF</span> <span class="op">&lt;-</span> <span class="kw">MazamaSpatialUtils</span>::<span class="fu"><a href="https://rdrr.io/pkg/MazamaSpatialUtils/man/summarizeByPolygon.html">summarizeByPolygon</a></span>(
  longitude = <span class="kw">dailyMax</span><span class="op">$</span><span class="kw">longitude</span>,
  latitude = <span class="kw">dailyMax</span><span class="op">$</span><span class="kw">latitude</span>,
  value = <span class="kw">newValueVector</span>, 
  SPDF = <span class="kw">stateSPDF</span>,
  useBuffering = <span class="fl">TRUE</span>,
  FUN = <span class="kw">mean</span>
)

<span class="co"># add summarized values to stateSPDF@data</span>
<span class="kw">stateSPDF</span><span class="op">@</span>data <span class="op">&lt;-</span> <span class="kw">stateSPDF</span><span class="op">@</span>data <span class="op">%&gt;%</span>
  <span class="kw">dplyr</span>::<span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span>(<span class="kw">stateSummarizedDF</span>, by = <span class="st">"polygonID"</span>) <span class="op">%&gt;%</span>
  <span class="kw">dplyr</span>::<span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(avgPM25 = <span class="kw">summaryValue</span>)

<span class="co">#createMap</span>
<span class="kw">tmap</span>::<span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape</a></span>(<span class="kw">stateSPDF</span>) <span class="op">+</span>
  <span class="kw">tmap</span>::<span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html">tm_polygons</a></span>(
    col = <span class="st">"avgPM25"</span>,
    breaks = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">5</span>, <span class="fl">13</span>, <span class="fl">2</span>), <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">15</span>, <span class="fl">70</span>, <span class="fl">5</span>)),
    border.col = <span class="st">"black"</span>) <span class="op">+</span>
  <span class="kw">tmap</span>::<span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_layout.html">tm_layout</a></span>(
    main.title = <span class="st">"Latest Average Daily Max Monitor Reading"</span>,
    main.title.position = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"center"</span>, <span class="st">"top"</span>),
    bg.color = <span class="st">"deepskyblue4"</span>,
    attr.color = <span class="st">"white"</span>,
    legend.position = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"right"</span>, <span class="st">"bottom"</span>)
  )
</pre></div>
<p><img src="Working_with_Locations_files/figure-html/plot_summarized-1.png" width="700"></p>
</div>
<div id="sprinkle-points-on-summarized-value-maps" class="section level2">
<h2 class="hasAnchor">
<a href="#sprinkle-points-on-summarized-value-maps" class="anchor"></a>Sprinkle Points on Summarized Value Maps</h2>
<p>In this section, we use both the state-level and monitor-level SPDFs to create a map with states colored by average air quality and monitor location points colored and sized by the maximum daily average PM2.5 concentrations</p>
<p>In the example below <code><a href="../../reference/stateMap.html">MazamaSpatialPlots::stateMap()</a></code> is used for the state-level map and colors. Various <strong>tmap</strong> functions are added to overlay the monitor location points.</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="co">#subset SPDFs</span>
<span class="kw">selectedStateCodeList</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'ME'</span>, <span class="st">'NH'</span>, <span class="st">'VT'</span>, <span class="st">'MA'</span>, <span class="st">'RI'</span>, <span class="st">'CT'</span>)
<span class="kw">selectedStateSPDF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(<span class="kw">stateSPDF</span>, <span class="kw">stateCode</span> <span class="op">%in%</span> <span class="kw">selectedStateCodeList</span>)
<span class="kw">selectedMonitorSPDF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(<span class="kw">monitorSPDF</span>, <span class="kw">stateCode</span> <span class="op">%in%</span> <span class="kw">selectedStateCodeList</span>)

<span class="co"># Now use different size markers since all are AIRNOW in new england</span>
<span class="fu"><a href="../../reference/stateMap.html">stateMap</a></span>(
  data = <span class="kw">selectedStateSPDF</span><span class="op">@</span>data,
  parameter = <span class="st">"avgPM25"</span>, <span class="co"># color states by average PM Value</span>
  stateCode = <span class="kw">selectedStateCodeList</span>,
  stateBorderColor = <span class="st">'white'</span>, 
  breaks = <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">1</span>, <span class="fl">20</span>, <span class="fl">2</span>),
) <span class="op">+</span>
  <span class="kw">tmap</span>::<span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape</a></span>(<span class="kw">selectedMonitorSPDF</span>) <span class="op">+</span>  <span class="co"># plot points of each monitor location with color </span>
  <span class="kw">tmap</span>::<span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_symbols.html">tm_bubbles</a></span>(          <span class="co"># and size based on PM value reading of the monitor</span>
    size = <span class="st">"pm25"</span>,
    col = <span class="st">"pm25"</span>, 
    border.col = <span class="st">'black'</span>,
    breaks = <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">1</span>, <span class="fl">20</span>, <span class="fl">2</span>),
    scale = <span class="fl">.9</span>,
    legend.size.show = <span class="kw">F</span>,
    legend.col.show = <span class="kw">F</span>
    ) <span class="op">+</span>
  <span class="kw">tmap</span>::<span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_layout.html">tm_layout</a></span>(
    main.title = <span class="st">'Air Quality in New England'</span>,
    main.title.size = <span class="fl">1.1</span>,
    fontfamily = <span class="st">"serif"</span>,
    bg.color = <span class="st">"lightblue3"</span>,
  )
</pre></div>
<p><img src="Working_with_Locations_files/figure-html/plot_summarized_points-1.png" width="700"></p>
<p>This next example only uses <strong>tmap</strong> functions. The <code>tm_symbols()</code> function is used to plot the monitor locations so the point shapes can be specified.</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="co">#subset SPDFs</span>
<span class="kw">selectedStateCodeList</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"CA"</span>, <span class="st">"OR"</span>, <span class="st">"WA"</span>, <span class="st">"NV"</span>, <span class="st">"ID"</span>, <span class="st">"UT"</span>, <span class="st">"AZ"</span>)
<span class="kw">selectedStateSPDF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(<span class="kw">stateSPDF</span>, <span class="kw">stateCode</span> <span class="op">%in%</span> <span class="kw">selectedStateCodeList</span>)
<span class="kw">selectedMonitorSPDF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(<span class="kw">monitorSPDF</span>, <span class="kw">stateCode</span> <span class="op">%in%</span> <span class="kw">selectedStateCodeList</span>)

<span class="co"># can also do it with just tmap</span>
<span class="kw">tmap</span>::<span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape</a></span>(<span class="kw">selectedStateSPDF</span>) <span class="op">+</span>
  <span class="kw">tmap</span>::<span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html">tm_polygons</a></span>(
    col = <span class="st">"avgPM25"</span>, 
    palette = <span class="st">"YlOrBr"</span>,
    border.col = <span class="st">"black"</span>,
    breaks = <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">0</span>, <span class="fl">50</span>, <span class="fl">5</span>),
    legend.show = <span class="fl">FALSE</span>) <span class="op">+</span>
  <span class="kw">tmap</span>::<span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape</a></span>(<span class="kw">selectedMonitorSPDF</span>) <span class="op">+</span>  <span class="co"># plot points of each monitor location with color </span>
  <span class="kw">tmap</span>::<span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_symbols.html">tm_symbols</a></span>(          <span class="co"># and size based on PM value reading of the monitor</span>
    col = <span class="st">"pm25"</span>,
    palette = <span class="st">"YlOrBr"</span>,
    breaks = <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">0</span>, <span class="fl">50</span>, <span class="fl">5</span>),
    shape = <span class="st">"plotDataSource"</span>,
    shapes = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">21</span>, <span class="fl">24</span>),
    scale = <span class="fl">.6</span>
  ) <span class="op">+</span>
  <span class="kw">tmap</span>::<span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_layout.html">tm_layout</a></span>(
    main.title = <span class="st">"Air Quality in Western U.S. States"</span>,
    main.title.position = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"left"</span>, <span class="st">"top"</span>),
    main.title.size = <span class="fl">1.1</span>,
    fontfamily = <span class="st">"serif"</span>,
    legend.outside = <span class="kw">T</span>,
    bg.color = <span class="st">"lightblue3"</span>, 
    inner.margins = <span class="fl">.1</span>,
  )
</pre></div>
<p><img src="Working_with_Locations_files/figure-html/plot_summarized_points2-1.png" width="700"></p>
</div>
<div id="conclusion" class="section level2">
<h2 class="hasAnchor">
<a href="#conclusion" class="anchor"></a>Conclusion</h2>
<p>Using a few key functions from <strong>MazamaSpatialUtls</strong>, <strong>MazamaSpatialPlots</strong> and <strong>PWFSLSmoke</strong> makes it easy to create detailed and descriptive maps containing both regional averages as well as spatial data point measurements. The examples in this article demonstrate several ways to leverage these functions as well as customization capabilities from the <strong>tmap</strong> package.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jonathan Callahan, Rachel Carroll, Eli Grosman.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
